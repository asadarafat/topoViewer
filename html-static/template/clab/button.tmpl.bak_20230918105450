<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Topology Viewer</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
		<link href="css/style.css" rel="stylesheet"/>
		<script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
	</head>
	<style>
		body { 
		font: 14px helvetica neue, helvetica, arial, sans-serif;
		}
		#edgeLength, #nodeSpacing {
		width: 100%;
		}
		#cy {
		position: absolute;
		left: 0;
		right: 0;
		top: 4.0em;
		bottom: 0;
		right: 26em;
		}
		#logo {
		top: 20px; 
		left: 30px;
		z-index: 9999;
		position: absolute;
		}
		#Panel-01 {
		top: 60px; 
		right: 10px; 
		width: 350px; 
		position: absolute;
		}
		#Panel-02 {
		bottom: 0px; 
		right: 10px; 
		width: 350px; 
		position: absolute;
		}
		.has-background-4a {
		background-color: #275bd4;
		z-index: 9999;
		}
	</style>
	<body>
		<nav class="level m-0 px-3 py-1 has-background-4a">
			<div>
				<p class="title    m-0 px-1 py-0   is-4 is-unselectable has-text-weight-normal has-text-white"> TopoViewer</p>
				<p class="subtitle m-0 px-1 py-0   is-6                 has-text-weight-light  has-text-white" id="ClabSubtitle">Topology name:nokia-MAGc-lab ::: Uptime: 10m10s</p>
			</div>
			<div class="level-right">
				<div id="nokia-logo">
					<img src="images/nokia-logo.png" width="100" hspace="10" vspace="5"><br>
				</div>
				<div class="level-item">
					<div class="dropdown is-hoverable is-right">
						<div class="dropdown-trigger">
							<button class="button is-small is-link is-light" aria-haspopup="true" aria-controls="dropdown-menu3">
							<i class="icon fas fa-solid fa-bars fa-lg" aria-hidden="true"></i>
							</button>
						</div>
						<div class="dropdown-menu" id="dropdown-menu" role="menu">
							<div class="dropdown-content">
								<div class="dropdown-item">
									<label class="label has-text-weight-normal is-small">Edge Length</label>
									<input id="edgeLength" type="range" min="1" max="1000" step="1" value="50">
								</div>
								<div class="dropdown-item">
									<label class="label has-text-weight-normal is-small">Node Spacing</label>
									<input id="nodeSpacing" type="range" min="1" max="1000" step="1" value="25">
								</div>
								<a id="addNodeButton" href="#" class="dropdown-item label has-text-weight-normal is-small">Add Node and Edge</a>   
								<a id="generateNodesDropDown" href="#" class="dropdown-item label has-text-weight-normal is-small">Generate Node and Edge</a>   
								<a id="toggleLinkEndpoint" href="#" onclick="toggleLinkEndpoint();" class="dropdown-item label has-text-weight-normal is-small">Toggle Link Endpoint</a>
								<a id="SetNodeDockerStatus" href="#" onclick="toggleDockerStatusVisibility();" class="dropdown-item label has-text-weight-normal is-small">Toggle Node Docker Status</a>
								<a id="about" href="#" onclick="about();" class="dropdown-item label has-text-weight-normal is-small">About TopoViewer</a>                      
							</div>
						</div>
					</div>
				</div>
			</div>
		</nav>
		<div id="cy-container">
			<div id="cy"></div>
			<div class="panel" id="Panel-01" style="display: none;">
				<p class="panel-heading is-size-6">Actions</p>
				<div class="panel-block">
					<div id="nodeAttributes">
						<label class="label is-size-7" for="nodeName">Node Spawner:</label>
						<input class="input is-small" type="text" id="nodeName" placeholder="Node Name">
						<button class="button is-small" id="addNodeSubmit">Spwan</button>
					</div>
					<div id="nodeGenerate">
						<label class="label is-size-7" for="generateNodesInput">Network Maker:</label>
						<input class="input is-small" type="text" id="generateNodesInput" placeholder="Node Number">
						<button class="button is-small" id="generateNodesButton">Generate</button>
					</div>
				</div>
				<div class="panel-block">
					<label class="label is-size-7" for="nodeFindInput">Find Node :</label>
					<div id="nodeFind">
						<input class="input is-small" type="text" id="nodeFindInput" placeholder="Node Name">
						<button class="button is-small" id="nodeFindButton">Find</button>
						<button class="button is-small" id="fitAllNodesAction">Zoom to Fit</button>
					</div>
				</div>
				<div class="panel-block">
					<label class="label is-size-7" >Path Finder:</label>
					<div id="nodeAttributes">
						<input class="input is-small" type="text" id="findPathSourceNode" placeholder="Source Node Name">
						<input class="input is-small" type="text" id="findPathTargetNode" placeholder="Target Node Name">
						<button class="button is-small" id="findPathButton">Find Path</button>
					</div>
				</div>
				<div class="panel-block">
					<button class="button is-small" id="connectNodesAction">Connect Nodes</button>
				</div>
				<div class="panel-block">
					<button class="button is-small" id="closeForm">Close</button>
				</div>
			</div>
		</div>
		<div class="panel" id="Panel-02" >
			<p class="panel-heading is-size-6 ">Notifications</p>
			<div class="panel-block">
				<textarea class="textarea is-small" id="notificationTextarea" rows="20" readonly></textarea>
			</div>
		</div>
		<script src="/cytoscape/libs/cytoscape-cola.js"></script>
		<script src="/cytoscape/libs/cola.min.js"></script>
		<!-- <script src="/cytoscape/libs/cytoscape.min.js"></script> -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.0/cytoscape.min.js"></script>
		<script src="/cytoscape/libs/cytoscape-cola.js"></script>
		<script src="/cytoscape/libs/popper.js"></script>
		<script src="/cytoscape/libs/cytoscape-popper.js"></script>
		<script src="/cytoscape/libs/cytoscape-grid-guide.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/cytoscape-dijkstra@2.0.1/cytoscape-dijkstra.js"></script>

		<script>
			document.addEventListener('DOMContentLoaded', function() {
{{rawJSComment "				//- Initialize Cytoscape.js"}}
				const cy = cytoscape({
					container: document.getElementById('cy'),
					elements: [],
					style: [
					{
						selector: 'node',
						style: {
							'background-color': '#3498db',
							'label': 'data(label)'
						}
					}]
				});

{{rawJSComment "				//- Toggle the Panel-01 when clicking on the cy container "}}
				document.getElementById('cy').addEventListener('click', () => {
					var panel = document.getElementById('Panel-01');
					if (panel.style.display === 'none' || panel.style.display === '') {
{{rawJSComment "						//- Show the panel"}}
						panel.style.display = 'block';
						panel.classList.toggle('active');
					} else {
{{rawJSComment "						//- Hide the panel"}}
						panel.style.display = 'none';
					}
					console.log("Panel-01.style: " + document.getElementById('Panel-01').style.display)
				});

				document.getElementById('connectNodesAction').addEventListener('click', () => {
{{rawJSComment "					//- Implement logic to connect nodes here "}}
{{rawJSComment "					//- You can create edges between nodes, similar to what you did before "}}
				});

{{rawJSComment "				//- Add click event listener to 'Zoom to Fit' the form "}}
				document.getElementById('fitAllNodesAction').addEventListener('click', () => {
{{rawJSComment "					//- Get the current zoom level"}}
					const currentZoom = cy.zoom();
{{rawJSComment "					//- Fit all nodes with padding"}}
					cy.fit();
				});

{{rawJSComment "				//- Add click event listener to close the form "}}
				document.getElementById('closeForm').addEventListener('click', () => {
					var panel = document.getElementById('Panel-01');
					if (panel.style.display === 'none' || panel.style.display === '') {
{{rawJSComment "						//- Show the panel"}}
						panel.style.display = 'block';
						panel.classList.toggle('active');
					} else {
{{rawJSComment "						//- Hide the panel"}}
						panel.style.display = 'none';
					}
					console.log("Panel-01.style: " + document.getElementById('Panel-01').style.display)
				});

{{rawJSComment "				//- Add a click event listener to the 'Submit' button in the hidden form"}}
				document.getElementById('addNodeSubmit').addEventListener('click', () => {
{{rawJSComment "					//- Get the node name from the input field "}}
					const nodeName = document.getElementById('nodeName').value;
					console.log(nodeName)
{{rawJSComment "					//- Check if a node name is empty "}}
					if (nodeName == "") {
{{rawJSComment "						//- append message in textArea "}}
						appendMessage('Error: Enter node name.');
						return;
					}
{{rawJSComment "					//- Check if a node with the same name already exists "}}
					if (cy.$(`node[id = "${nodeName}"]`).length > 0) {
{{rawJSComment "						//- append message in textArea "}}
						appendMessage('Error: Node with this name already exists.');
						return;
					}
{{rawJSComment "					//- Create a new node element "}}
					const newNode = {
						group: 'nodes',
						data: {
							id: nodeName,
							name: nodeName,
							label: nodeName
						}
					};
{{rawJSComment "					//- Add the new node to Cytoscape.js "}}
					cy.add(newNode);
{{rawJSComment "					//- Randomize the positions and center the graph "}}
					const layout = cy.layout({
						name: 'cola',
						nodeSpacing: 5,
						edgeLengthVal: 45,
						animate: true,
						randomize: false,
						maxSimulationTime: 1500
					});
					layout.run();
{{rawJSComment "					//- Append a notification message to the textarea "}}
					appendMessage(`Notification: Node added successfully - ${nodeName}`);
				});
				
{{rawJSComment "				//- Add a click event listener to the 'Generate' button"}}
				document.getElementById('generateNodesButton').addEventListener('click', () => {
{{rawJSComment "					//- Get the number of node from the input field  "}}
					const numNodes = document.getElementById('generateNodesInput').value;
					console.log(numNodes)
{{rawJSComment "					//- Check if the number of node is empty  "}}
					if (numNodes === null) {
{{rawJSComment "						//- if node number empty do nothing "}}
						return;
					}
					const numNodesToGenerate = parseInt(numNodes, 10);
{{rawJSComment "					//- Check if the number of node is positive "}}
					if (isNaN(numNodesToGenerate) || numNodesToGenerate <= 0) {
{{rawJSComment "						//- Invalid input"}}
						appendMessage('Error: Please enter a valid positive number.');
						return;
					}
{{rawJSComment "					//- Generate nodes with random positions"}}
					for (let i = 0; i < numNodesToGenerate; i++) {
						const nodeName = `node-${i + 1}`;
						const newNode = {
							group: 'nodes',
							data: {
								id: nodeName,
								name: nodeName,
								label: nodeName
							},
							position: {
								x: Math.random() * 400,
								y: Math.random() * 400
							}
						};
{{rawJSComment "						//-cy.add(newNode);"}}
						try {
							cy.add(newNode);
{{rawJSComment "							//- throw new Error('This is an example exception');"}}
						} catch (error) {
{{rawJSComment "							//- Log the exception to the console"}}
							console.error("An exception occurred:", error);
{{rawJSComment "							//- Log the exception to notification message to the textarea "}}
							appendMessage(error);
						}
					}
{{rawJSComment "					//- Generate random edges between nodes"}}
					for (let i = 0; i < numNodesToGenerate; i++) {
						const sourceNode = `node-${i + 1}`;
						const targetNode = `node-${Math.floor(Math.random() * numNodesToGenerate) + 1}`;
						if (sourceNode !== targetNode) {
							const newEdge = {
								group: 'edges',
								data: {
									source: sourceNode,
									target: targetNode
								}
							};
							try {
								cy.add(newEdge);
{{rawJSComment "								//- throw new Error('This is an example exception');"}}
							} catch (error) {
{{rawJSComment "								//- Log the exception to the console"}}
								console.error("An exception occurred:", error);
{{rawJSComment "								//- Log the exception to notification message to the textarea "}}
								appendMessage(error);
							}
						}
					}
{{rawJSComment "					//- run layout"}}
					const layout = cy.layout({
						name: 'cola',
						nodeSpacing: 5,
						edgeLengthVal: 45,
						animate: true,
						randomize: false,
						maxSimulationTime: 1500
					});
					layout.run();
{{rawJSComment "					//-//- Append a notification message to the textarea"}}
					appendMessage(`Notification: Generated ${numNodesToGenerate} nodes and random edges.`);
				});
				
{{rawJSComment "				//- Add a click event listener to the 'Find Node' button"}}
				document.getElementById('nodeFindButton').addEventListener('click', async () => {
					const nodeName = document.getElementById('nodeFindInput').value;
					await findNode(nodeName);
				});

{{rawJSComment "				//- Add a click event listener to the 'Find Path' button"}}
				document.getElementById('findPathButton').addEventListener('click', async () => {
					const sourceNode = document.getElementById('findPathSourceNode').value;
					const targetNode = document.getElementById('findPathTargetNode').value;
					highlightShortestPath(sourceNode, targetNode);
				});
				


{{rawJSComment "				//- Function to find and highlight a node by name"}}
				async function findNode(nodeName) {
{{rawJSComment "					//- Get a reference to your Cytoscape instance (assuming it's named 'cy')"}}
{{rawJSComment "					//- const cy = window.cy; //- Replace 'window.cy' with your actual Cytoscape instance"}}
{{rawJSComment "					//- Find the node with the specified name"}}
					const node = cy.$(`node[name = "${nodeName}"]`);
{{rawJSComment "					//- Check if the node exists"}}
					if (node.length > 0) {
{{rawJSComment "						//- Apply a highlight style to the node"}}
						node.style({
							'border-color': 'red',
							'border-width': '2px',
							'background-color': 'yellow'
						});
{{rawJSComment "						//- Zoom out on the node"}}
						cy.fit()
{{rawJSComment "						//- Zoom in on the node"}}
						cy.animate({
							zoom: {
								level: 5,
								position: {
									x: node.position('x'),
									y: node.position('y')
								},
								renderedPosition: {
									x: node.renderedPosition('x'),
									y: node.renderedPosition('y')
								}
							},
							duration: 1500
						});
					} else {
						console.error(`Node with name "${nodeName}" not found.`);
						appendMessage(`Node with name "${nodeName}" not found.`);
					}
				}

{{rawJSComment "				// Usage example:"}}
{{rawJSComment "				// highlightShortestPath('node-a', 'node-b'); // Replace with your source and target node IDs"}}
{{rawJSComment "				//- Function to get the default node style from cy-style.json"}}
{{rawJSComment "				//- weight: (edge) => 1, // You can adjust the weight function if needed"}}
{{rawJSComment "				//- weight: (edge) => edge.data('distance')"}}

				function highlightShortestPath(sourceNodeId, targetNodeId) {
{{rawJSComment "					// Assuming you have 'cy' as your Cytoscape instance"}}
					const sourceNode = cy.$(`node[id="${sourceNodeId}"]`);
					const targetNode = cy.$(`node[id="${targetNodeId}"]`);

					console.log(sourceNode)
					console.log(targetNode)

					if (!sourceNode || !targetNode) {
						console.error('Source or target node not found.');
						return;
					}

{{rawJSComment "					// Get the Dijkstra result with the shortest path"}}
					const dijkstraResult = cy.elements().dijkstra({
						root: sourceNode,
						weight: (edge) => 1, // You can adjust the weight function if needed
					});
{{rawJSComment "					// Get the shortest path from Dijkstra result"}}
					const shortestPathEdges = dijkstraResult.pathTo(targetNode);
{{rawJSComment "					// Apply a style to highlight the shortest path edges"}}
					shortestPathEdges.style({
						'line-color': 'red', // Highlight color
						'line-style': 'solid', // Highlighted style
					});
				}

{{rawJSComment "				//- Function to get the default node style from cy-style.json"}}
				async function getDefaultNodeStyle(node) {
					try {
{{rawJSComment "						//- Fetch the cy-style.json file"}}
						const response = await fetch('cy-style.json');
{{rawJSComment "						//- Check if the response is successful (status code 200)"}}
						if (!response.ok) {
							throw new Error(`Failed to fetch cy-style.json (${response.status} ${response.statusText})`);
						}
{{rawJSComment "						//- Parse the JSON response"}}
						const styleData = await response.json();
{{rawJSComment "						//- Extract the default node style from the loaded JSON"}}
{{rawJSComment "						//- Adjust this based on your JSON structure"}}
						const defaultNodeStyle = styleData[0].style;
						return defaultNodeStyle;
					} catch (error) {
						console.error('Error loading cy-style.json:', error);
						appendMessage(`Error loading cy-style.json: ${error}`);
{{rawJSComment "						//- Return a default style in case of an error"}}
						return {
							'background-color': 'blue',
							'border-color': 'gray',
							'border-width': '1px'
						};
					}
				}
				
{{rawJSComment "				//- Append message function"}}
				function appendMessage(message) {
					const textarea = document.getElementById('notificationTextarea');
					textarea.value += message + '\n';
					textarea.scrollTop = textarea.scrollHeight;
				}

{{rawJSComment "				//- Load and apply Cytoscape styles from cy-style.json using fetch"}}
				fetch('cy-style.json')
					.then(response => response.json())
					.then(styles => {
{{rawJSComment "						//- Apply styles loaded from cy-style.json"}}
						cy.style().fromJson(styles).update();
					})
					.catch(error => {
						console.error('Error loading styles:', error);
						appendMessage(`Error loading styles: ${error}`);
					});

			});
		</script>
	</body>
</html>
